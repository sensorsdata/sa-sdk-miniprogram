"use strict";var popup={sa:{},info:{app_id:"",show_log:!0},campaign_listener:{},lib_version:"0.4.8",defaultPara:{platform:"MINIPROGRAM",preload_image:!0,defer_render:!1},serverData:{},localData:{},event_list:[],popuping:!1,convertPlans:[],eventRule:{},popupTree:{},log:function(){if(popup.info.show_log&&"object"==typeof console&&console.log)try{return console.log.apply(console,arguments)}catch(t){console.log(arguments[0])}},CAMPAIGN_ERROR:{}},getRandomBasic=function(){var t=(new Date).getTime();return function(e){return Math.ceil((t=(9301*t+49297)%233280)/233280*e)}}(),_={getRgba:function(t){return"object"!=typeof t?t:"rgba("+t.r+","+t.g+","+t.b+","+t.a+")"},getRpx:function(t){if(t){if(/^[0|1]?\.\d+$/.test(t))return 100*Number(t)+"%";var e=/^(-?\d+(\.\d+)?)px$/.exec(t);return e?2*Number(e[1])+"rpx":t}},extend:function(t){var e=Array.prototype.slice;return _.each(e.call(arguments,1),function(e){for(var p in e)void 0!==e[p]&&(t[p]=e[p])}),t},each:function(t,e,p){var n=Array.prototype.forEach,o={};if(null==t)return!1;if(n&&t.forEach===n)t.forEach(e,p);else if(t.length===+t.length){for(var i=0,r=t.length;i<r;i++)if(i in t&&e.call(p,t[i],i,t)===o)return!1}else for(var a in t)if(hasOwnProperty.call(t,a)&&e.call(p,t[a],a,t)===o)return!1},extend2Lev:function(t){var e=Array.prototype.slice;return _.each(e.call(arguments,1),function(e){for(var p in e)void 0!==e[p]&&null!==e[p]&&(_.isObject(e[p])&&_.isObject(t[p])?_.extend(t[p],e[p]):t[p]=e[p])}),t},getRandom:function(){if("function"==typeof Uint32Array){var t="";if("undefined"!=typeof crypto?t=crypto:"undefined"!=typeof msCrypto&&(t=msCrypto),_.isObject(t)&&t.getRandomValues){var e=new Uint32Array(1);return t.getRandomValues(e)[0]/Math.pow(2,32)}}return getRandomBasic(1e19)/1e19},getUuid:function(){var t=function(){return _.getRandom().toString(16).replace(".","")};return function(){var e=function(){for(var t=1*new Date,e=0;t==1*new Date;)e++;return t.toString(16)+e.toString(16)}()+"-"+t()+"-"+t();return e||(String(_.getRandom())+String(_.getRandom())+String(_.getRandom())).slice(2,15)}},trim:function(t){return t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")},isEmptyObject:function(t){var e=Object.prototype.hasOwnProperty;if(_.isObject(t)){for(var p in t)if(e.call(t,p))return!1;return!0}return!1},filter:function(t,e,p){var n=Object.prototype.hasOwnProperty;if(t.filter)return t.filter(e);for(var o=[],i=0;i<t.length;i++)if(n.call(t,i)){var r=t[i];e.call(p,r,i,t)&&o.push(r)}return o},isObject:function(t){return null!=t&&"[object Object]"==Object.prototype.toString.call(t)},isArray:Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},isString:function(t){return"[object String]"==Object.prototype.toString.call(t)},isDate:function(t){return"[object Date]"==Object.prototype.toString.call(t)},isBoolean:function(t){return"[object Boolean]"==Object.prototype.toString.call(t)},isNumber:function(t){return"[object Number]"==Object.prototype.toString.call(t)&&/[\d\.]+/.test(String(t))},isFunction:function(t){if(!t)return!1;var e=Object.prototype.toString.call(t);return"[object Function]"==e||"[object AsyncFunction]"==e},getURLSearchParams:function(t){for(var e=function(t){return decodeURIComponent(t)},p={},n=(t||"").split("&"),o=0;o<n.length;o++){var i=n[o].indexOf("=");if(-1!==i){var r=n[o].substring(0,i),a=n[o].substring(i+1);r=e(r),a=e(a),p[r]=a}}return p}};function decrypt(t){return _.isString(t)?(popup.sa&&-1!==t.indexOf("data:enc;")&&(t=rot13defs(t=t.substring("data:enc;".length))),t):t}function encrypt(t){var e=!1;if(popup.sa&&popup.sa.para&&(e=popup.sa.para.encrypt_storage),e){_.isObject(t)&&(t=JSON.stringify(t)),t="data:enc;"+rot13obfs(t)}return t}function rot13obfs(t,e){e="number"==typeof e?e:13;for(var p=(t=String(t)).split(""),n=0,o=p.length;n<o;n++){p[n].charCodeAt(0)<126&&(p[n]=String.fromCharCode((p[n].charCodeAt(0)+e)%126))}return p.join("")}function rot13defs(t){return rot13obfs(t=String(t),113)}_.setStorageSync=function(t,e){var p=function(){var p=encrypt(e);wx.setStorageSync(t,p)};try{p()}catch(t){logger.info("set Storage fail --",t);try{p()}catch(t){logger.info("set Storage fail again --",t)}}},_.getStorageSync=function(t){var e="";try{e=decrypt(e=wx.getStorageSync(t))}catch(p){try{e=decrypt(e=wx.getStorageSync(t))}catch(t){logger.info("getStorage fail")}}return e},_.parseStorageSync=function(t){var e=null;try{e=JSON.parse(_.getStorageSync(t))||null}catch(t){}return e},_.isArray=Array.isArray||function(t){return"[object Array]"===toString.call(t)},_.matchImage=function(t){for(var e,p,n,o=new RegExp('("(backgroundImage|image)":"(http(s)?://.[^"]*))',"g"),i=new RegExp("http(s)?://.[^S]*"),r={},a=t.length,u=[],s=0;s<a;s++)if(e=!1,_.isObject(t[s])&&"ACTIVE"===t[s].status.toLocaleUpperCase()&&t[s].is_audience&&(t[s].hasOwnProperty("strategy_id")?t[s].is_trigger&&(e=!0):t[s].is_control_group||(e=!0)),e&&t[s].popup_window_content&&t[s].popup_window_content.content&&(p=t[s].popup_window_content.content.match(o)))for(var l=0,c=p.length;l<c;l++)(n=p[l].match(i))&&n.length>0&&(r[n[0]]||(r[n[0]]=1));return _.each(r,function(t,e){u.push(e)}),u},_.getConvertNumberValue=function(t){return _.isString(t)&&(t=Number(t)),Math.floor(1e3*t)/1e3},_.wxrequest=function(t){var e=wx.request(t);setTimeout(function(){_.isObject(e)&&_.isFunction(e.abort)&&e.abort()},3e4)},_.getProject=function(t){if(t&&t.split("?")[1]){var e=decodeURIComponent(t.split("?")[1]);return _.getURLSearchParams(e).project||"default"}return"default"},_.getCurrentPage=function(){var t=getCurrentPages(),e=t[t.length-1];return!!_.isObject(e)&&e},_.getPropertiesValue=function(t,e){var p=t[e];return"$event_duration"===e&&void 0===p&&(p=t.event_duration),p},popup._=_,popup.handleEvents=function(t,e){if("send"===t){if(popup.popuping)return popup.event_list.push(e),!1;e.event&&popup.eventRule[e.event]&&popup.eventTriggerProcess(popup.eventRule[e.event],e)}if("changeDistinctId"===t&&popup.updateAndListenPlan.changeId(),"popup_display"===t){popup.popuping=!0;try{popup.info.popup_listener.onLoadSuccess(e.plan.plan_id)}catch(t){popup.log("popup_listener.onLoad error",t)}}if("popup_load_fail"===t){var p=e.plan_id,n=e.fail_code,o=e.fail_reason;try{popup.info.popup_listener.onLoadFailed(p,n,o)}catch(t){popup.log("popup_listener.onLoad error",t)}}if("popup_click"===t&&popup.track.popupClick(e),"popup_end"===t){popup.popuping=!1;var i={name:e.plan.cname,plan_id:e.plan.plan_id,content:e.plan.popup_window_content?e.plan.popup_window_content.content:"",type:e.plan.popup_window_content?e.plan.popup_window_content.popup_type:""};popup.CAMPAIGN_ERROR.onEnd||popup.campaign_listener.onEnd(i);try{popup.info.popup_listener.onClose(e.plan.plan_id)}catch(t){popup.log("popup_listener.onLoad error",t)}popup.updateGlobalCount(),popup.updatePlanInterval(e.plan),_.each(popup.event_list,function(t){t.event&&popup.eventRule[t.event]&&popup.eventTriggerProcess(popup.eventRule[t.event],t)}),popup.event_list=[]}},popup.setPara=function(t){if(_.isObject(t)||(t={}),popup.info=_.extend(popup.info,popup.defaultPara,t),popup.info.app_id||popup.log("\u521d\u59cb\u5316\u53c2\u6570 appid \u6821\u9a8c\u5931\u8d25\uff0c\u65e0\u6cd5\u62c9\u53d6\u5f39\u7a97\u8ba1\u5212!"),_.isString(popup.info.api_base_url)&&"http"===popup.info.api_base_url.slice(0,4)||popup.log("popup \u5fc5\u987b\u586b\u5199\u6709\u6548 api_base_url"),popup.info.project||(popup.info.project=_.getProject(popup.sa.para.server_url)),_.isObject(popup.info.popup_listener)){var e=popup.info.popup_listener;_.isFunction(e.onClick)||(popup.info.popup_listener.onClick=function(){}),_.isFunction(e.onLoadSuccess)||(popup.info.popup_listener.onLoadSuccess=function(){}),_.isFunction(e.onLoadFailed)||(popup.info.popup_listener.onLoadFailed=function(){}),_.isFunction(e.onClose)||(popup.info.popup_listener.onClose=function(){})}else popup.info.popup_listener={onClick:function(){},onLoadSuccess:function(){},onLoadFailed:function(){},onClose:function(){}};_.isObject(t.campaign_listener)?(popup.campaign_listener=_.extend({},t.campaign_listener),popup.campaign_listener.shouldStart&&_.isFunction(popup.campaign_listener.shouldStart)||(popup.campaign_listener.shouldStart=function(){return!0},popup.CAMPAIGN_ERROR.