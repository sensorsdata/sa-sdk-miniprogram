import device from"@system.device";import storage from"@system.storage";import fetch from"@system.fetch";var hasOwnProperty=Object.prototype.hasOwnProperty;function extend(e){return each(Array.prototype.slice.call(arguments,1),function(t){for(var r in t)void 0!==t[r]&&(e[r]=t[r])}),e}function each(e,t,r){var a=Array.prototype.forEach,i={};if(null==e)return!1;if(a&&e.forEach===a)e.forEach(t,r);else if(e.length===+e.length){for(var s=0,n=e.length;s<n;s++)if(s in e&&t.call(r,e[s],s,e)===i)return!1}else for(var o in e)if(hasOwnProperty.call(e,o)&&t.call(r,e[o],o,e)===i)return!1}function filter(e,t,r){if(e.filter)return e.filter(t);for(var a=[],i=0;i<e.length;i++)if(hasOwnProperty.call(e,i)){var s=e[i];t.call(r,s,i,e)&&a.push(s)}return a}function isObject(e){return null!=e&&"[object Object]"==Object.prototype.toString.call(e)}function isEmptyObject(e){if(isObject(e)){for(var t in e)if(hasOwnProperty.call(e,t))return!1;return!0}return!1}function isArray(e){return!!e&&"[object Array]"===Object.prototype.toString.call(e)}function isString(e){return"[object String]"==Object.prototype.toString.call(e)}function isDate(e){return"[object Date]"==Object.prototype.toString.call(e)}function isBoolean(e){return"[object Boolean]"==Object.prototype.toString.call(e)}function isNumber(e){return"[object Number]"==Object.prototype.toString.call(e)&&/[\d\.]+/.test(String(e))}function isFunction(e){if(!e)return!1;var t=Object.prototype.toString.call(e);return"[object Function]"==t||"[object AsyncFunction]"==t}function getURLSearchParams(e){for(var t=function(e){return decodeURIComponent(e)},r={},a=(e||"").split("&"),i=0;i<a.length;i++){var s=a[i].indexOf("=");if(-1!==s){var n=a[i].substring(0,s),o=a[i].substring(s+1);n=t(n),o=t(o),r[n]=o}}return r}function log(){if("object"==typeof console&&console.log){isString(arguments[0])&&(arguments[0]="sensorsabtest————"+arguments[0]);try{return console.log.apply(console,arguments)}catch(e){console.log("sensorsabtest————",arguments[0])}}}function isJSONString(e){try{JSON.parse(e)}catch(e){return!1}return!0}function getQueryParam(e,t){t=t.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),e=decodeURIComponent(e);var r=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(e);return null===r||r&&"string"!=typeof r[1]&&r[1].length?"":decodeURIComponent(r[1])}function decodeURIComponent(e){var t=e;try{t=decodeURIComponent(e)}catch(r){t=e}return t}function formatSystem(e){var t=e.toLowerCase();return"ios"===t?"iOS":"android"===t?"Android":e}function validTimeout(e){return e.timeout_milliseconds&&isNumber(e.timeout_milliseconds)||(e.timeout_milliseconds=3e3),e.timeout_milliseconds<200&&(e.timeout_milliseconds=200),e}function indexOf(e,t){var r=e.indexOf;if(r)return r.call(e,t);for(var a=0;a<e.length;a++)if(t===e[a])return a;return-1}function rot13obfs(e,t){t="number"==typeof t?t:13;for(var r=(e=String(e)).split(""),a=0,i=r.length;a<i;a++){r[a].charCodeAt(0)<126&&(r[a]=String.fromCharCode((r[a].charCodeAt(0)+t)%126))}return r.join("")}function rot13defs(e){return rot13obfs(e=String(e),113)}function formatDate(e){function t(e){return e<10?"0"+e:e}return e.getFullYear()+"-"+t(e.getMonth()+1)+"-"+t(e.getDate())+" "+t(e.getHours())+":"+t(e.getMinutes())+":"+t(e.getSeconds())+"."+t(e.getMilliseconds())}function getRelativeValue(e,t){var r={},a={INTEGER:function(e){var t=parseFloat(e);isNaN(t)?_.log("\u539f\u59cb\u6570\u636e INTEGER \u7c7b\u578b\u89e3\u6790\u5f02\u5e38",e):(r.value=t,r.type="Number")},STRING:function(e){_.isString(e)?(r.value=e,r.type="String"):_.log("\u539f\u59cb\u6570\u636e STRING \u7c7b\u578b\u89e3\u6790\u5f02\u5e38",e)},JSON:function(e){if(_.isJSONString(e)){var t=JSON.parse(e);_.isObject(t)?(r.value=t,r.type="Object"):_.log("\u539f\u59cb\u6570\u636e JSON \u7c7b\u578b\u89e3\u6790\u5f02\u5e38",e)}},BOOLEAN:function(e){"true"===e?(r.value=!0,r.type="Boolean"):"false"===e?(r.value=!1,r.type="Boolean"):_.log("\u539f\u59cb\u6570\u636e BOOLEAN \u7c7b\u578b\u89e3\u6790\u5f02\u5e38",e)}};try{a[t]?a[t](e):_.log("\u8bd5\u9a8c\u6570\u636e\u7c7b\u578b\u89e3\u6790\u5931\u8d25",t,e)}catch(r){_.log(r,e,t)}return r}var _={extend:extend,each:each,filter:filter,isObject:isObject,isEmptyObject:isEmptyObject,isArray:isArray,isString:isString,isDate:isDate,isBoolean:isBoolean,isNumber:isNumber,isFunction:isFunction,getURLSearchParams:getURLSearchParams,log:log,isJSONString:isJSONString,getQueryParam:getQueryParam,decodeURIComponent:decodeURIComponent,formatSystem:formatSystem,validTimeout:validTimeout,indexOf:indexOf,rot13obfs:rot13obfs,rot13defs:rot13defs,formatDate:formatDate,getRelativeValue:getRelativeValue};function getSystemInfo(e,t){try{device.getInfo({success:function(t){e.props.$brand=t.brand,e.props.$manufacturer=t.manufacturer,e.props.$model=t.model,e.props.$os=t.osType,e.props.$os_version=t.osVersionName,log("get system info success")},complete:function(){isFunction(t)&&t()}})}catch(e){log("get system info fail")}}function setStorage(e,t){var r;try{r=JSON.stringify(t)}catch(e){log("\u5e8f\u5217\u5316\u7f13\u5b58\u5bf9\u8c61\u5931\u8d25\uff01")}try{storage.set({key:e,value:r,success:function(){log("set Storage success")},fail:function(){log("set Storage fail")}})}catch(e){log("set Storage fail",e)}}function getStorage(e,t){var r="";try{storage.get({key:e,success:function(e){isJSONString(e)&&(r=JSON.parse(e),t(r)),log("get storage success")},fail:function(e){log("get storage fail, ",e)}})}catch(e){log("get storage fail, ",e)}return r}function mixinStore(e){e.store={getStorage:getStorage,setStorage:setStorage}}function mixinFetch(e){e.fetchTest=function(){var t=0,r=!1,a=e.creatRequestData();function i(t){_.log("\u8bf7\u6c42\u6570\u636e\u7ed3\u679c\u6210\u529f: ",t),r=!0,e.updateData(t),e.state.fetchInterval&&clearTimeout(e.state.fetchInterval),e.state.fetchInterval=setTimeout(function(){e.request({url:e.para.url,method:"POST",data:JSON.stringify(a),timeout:e.para.timeout_milliseconds,suc:i,fail:s})},e.para.update_interval)}function s(n){return _.log("\u8bf7\u6c42\u6570\u636e\u7ed3\u679c\u5931\u8d25: ",n),t++,!r&&t<e.para.retry_times&&setTimeout(function(){e.request({url:e.para.url,method:"POST",data:JSON.stringify(a),timeout:e.para.timeout_milliseconds,suc:i,fail:s})},3e3),!1}e.request({url:e.para.url,method:"POST",data:JSON.stringify(a),timeout:e.para.timeout_milliseconds,suc:i,fail:s})},e.updateData=function(t){var r=t.results;e.resolveData(r),e.store.setStorage(e.info.storage_key,e.state.test_list),_.log("\u66f4\u65b0\u8bd5\u9a8c\u6570\u636e")},e.resolveData=function(t){if(!_.isArray(t))return _.log("\u89e3\u6790——\u6570\u636e\u683c\u5f0f\u9519\u8bef",t),!1;e.state.test_list={},_.each(t,function(t){_.isObject(t)&&t.variables&&_.isArray(t.variables)&&_.each(t.variables,function(r){_.isObject(r)&&!e.state.test_list[r.name]&&(e.state.test_list[r.name]={abtest_experiment_id:t.abtest_experiment_id,abtest_experiment_group_id:t.abtest_experiment_group_id,is_control_group:t.is_control_group,is_white_list:t.is_white_list,config:_.getRelativeValue(r.value,r.type)})})})},e.creatRequestData=function(t){var r=function(){var t={};if(!e._sa||!e._sa.store)return t;var r=e._sa.store.getFirstId(),a=e._sa.store.getDistinctId();r?(t.login_id=a,t.anonymous_id=r):t.anonymous_id=a;return t}(),a={anonymous_id:r.anonymous_id,platform:e.info.platform,abtest_lib_version:e.info.lib_version,properties:{$is_first_day:e._sa._.getIsFirstDay()}};if(e.info.scene&&(a.properties.$latest_scene=e.info.scene),r.login_id&&(a.login_id=r.login_id),e._sa._&&e._sa._.info&&e._sa._.info.currentProps)var i=e._sa._.info.currentProps.$latest_scene;return i&&(a.properties.$latest_scene=i),a.properties=_.extend({},a.properties,e.props),_.isObject(t)&&_.isObject(t.properties)&&(a.properties=_.extend({},a.properties,t.properties)),_.isObject(t)&&_.isObject(t.custom_properties)&&(a.custom_properties=_.extend({},t.custom_properties),a.param_name=t.param_name),a}}_.getSystemInfo=getSystemInfo;var VALUE_TYPE_LIST=["Number","String","Object","Boolean"],regName=/^((?!^distinct_id$|^original_id$|^time$|^properties$|^id$|^first_id$|^second_id$|^users$|^events$|^event$|^user_id$|^date$|^datetime$|^user_tag.*|^user_group.*)[a-zA-Z_][a-zA-Z\d_]*)$/i,verifyStore={valueType:function(e,t){switch(t){case"Number":if(_.isNumber(e))return!0;break;case"String":if(_.isString(e))return!0;break;case"Object":if(_.isObject(e))return!0;break;case"Boolean":if(!0===e||!1===e)return!0;break;default:return!1}return!1},para:function(e,t,r){var a=!0;return _.each(r,function(r){switch(r){case"param_name":t.param_name&&_.isString(t.param_name)&&t.param_name.length>0||(_.log(e+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cparam_name\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e\uff01param_name:",t.param_name),a=!1);break;case"value_type":_.isString(t.value_type)&&-1!==_.indexOf(VALUE_TYPE_LIST,t.value_type)||(_.log(e+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cvalue_type\u914d\u7f6e\u9519\u8bef",t.value_type),a=!1);break;case"default_value":void 0===t.default_value?(_.log(e+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cdefault_value\u53c2\u6570\u672a\u914d\u7f6e"),a=!1):verifyStore.valueType(t.default_value,t.value_type)||(_.log(e+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0cdefault_value\u7c7b\u578b\u5fc5\u987b\u4e0evalue_type\u4e00\u81f4\uff01",t.default_value,t.value_type),a=!1);break;case"callback":_.isFunction(t.callback)||(_.log(e+"\u65b9\u6cd5\u8c03\u7528\u5931\u8d25\uff0ccallback\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),a=!1)}}),a},resolveCustomProperties:function(e){var t={verify_success:!0,para:null},r=e.custom_properties;if(!_.isObject(r)||_.isEmptyObject(r))return delete e.custom_properties,t.para=e,t;if(_.each(r,function(e,r){if((!_.isString(r)||!regName.test(r)||r.length>100)&&(_.log(" property name [ "+r+" ] is not invalid "),t.verify_success=!1),(_.isString(e)||_.isNumber(e)||_.isBoolean(e)||_.isArray(e)||_.isDate(e))&&!(_.isString(e)&&e.length>500)||(_.log("property [ "+r+" ] of value [ "+JSON.stringify(e)+" ] is not invalid"),t.verify_success=!1),_.isArray(e)){var a=!0;_.each(e,function(e){!1!==a&&(_.isString(e)||(a=!1))}),a||(_.log("property  value type can be array, but only allow string item. property [ "+r+" ] of value  "+JSON.stringify(e)+"  is not invalid"),t.verify_success=!1)}}),!0===t.verify_success){var a={};_.each(r,function(e,t){_.isDate(e)?a[t]=_.formatDate(e):_.isString(e)?a[t]=e:a[t]=JSON.stringify(e)}),e.custom_properties=a}return t.para=e,t}};function defineApi(e,t){for(var r of t)e[r]="fetchCacheABTest"===r?function(e){if(_.log("\u8c03\u7528\u5206\u6d41 API --- A/B Testing \u63d2\u4ef6\u5c1a\u672a\u521d\u59cb\u5316\uff01"),Object.prototype.hasOwnProperty.call(e,"default_value"))return e.default_value}:function(e){_.log("\u8c03\u7528\u5206\u6d41 API --- A/B Testing \u63d2\u4ef6\u5c1a\u672a\u521d\u59cb\u5316\uff01"),e&&_.isFunction(e.callback)&&Object.prototype.hasOwnProperty.call(e,"default_value")&&e.callback(e.default_value)}}function initAPI(e){e.setPara=function(t){if(!_.isString(t.url)||"http"!==t.url.slice(0,4))return _.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0c\u8bf7\u4f7f\u7528\u6b63\u786e\u7684 URL\uff01"),!1;e.para.url=t.url;var r=_.getQueryParam(t.url,"project-key");return r?(e.para.project_key=r,_.isNumber(t.timeout_milliseconds)&&(t.timeout_milliseconds<200?e.para.timeout_milliseconds=200:e.para.timeout_milliseconds=t.timeout_milliseconds),_.isNumber(t.update_interval)&&(e.para.update_interval=t.update_interval),!0):(_.log("A/B Testing SDK \u521d\u59cb\u5316\u5931\u8d25\uff0c\u8bf7\u4f7f\u7528\u6b63\u786e\u7684 URL\uff08\u5fc5\u987b\u5305\u542b project-key\uff09\uff01"),!1)},e.asyncFetchABTest=function(t){if(!_.isObject(t))return _.log("asyncFetchABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;if(!verifyStore.para("asyncFetchABTest",t,["param_name","value_type","default_value","callback"]))return!1;var r=verifyStore.resolveCustomProperties(t);r.verify_success?(t=r.para,_.validTimeout(t),e.asyncFetch(t)):t.callback(t.default_value)},e.fastFetchABTest=function(t){if(!_.isObject(t))return _.log("fastFetchABTest \u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e"),!1;if(!verifyStore.para("fastFetchABTest",t,["param_name","value_type","default_value","callback"]))return!1;var r=verifyStore.resolveCustomProperties(t);if(r.verify_success){t=r.para,_.validTimeout(t);var a=e.searchLocalExp(t.param_name);if(_.isObject(a)){var i=e.getExpResult(t,a);t.callback(i)}else _.log("fastFetchABTest \u7f13\u5b58\u4e2d\u672a\u8bfb\u53d6\u5230\u6570\u636e\uff0c\u53d1\u8d77\u8bf7\u6c42"),e.asyncFetch(t)}else t.callback(t.default_value)},e.fetchCacheABTest=function(t){if(_.isObject(t))return!!verifyStore.para("fetchCacheABTest",t,["param_name","value_type","default_value"])&&e.getExpResult(t);_.log("fetchCacheABTest\u8c03\u7528\u5931\u8d25\uff0c\u53c2\u6570\u672a\u6b63\u786e\u914d\u7f6e")},e.asyncFetch=function(t){e.getResultFromServer({para:t,suc:function(r){if(_.isObject(r)&&"SUCCESS"===r.status){_.log("\u83b7\u53d6\u5230\u670d\u52a1\u7aef\u8bd5\u9a8c\u7ed3\u679c\u6570\u636e: ",r),e.updateData(r);var a=e.getExpResult(t);t.callback(a)}else t.callback(t.default_value)},fail:function(e){_.log("\u83b7\u53d6\u670d\u52a1\u7aef\u6570\u636e\u5931\u8d25: ",e),t.callback(t.default_value)}})},e.searchLocalExp=function(t){return!!e.state.test_list[t]&&e.state.test_list[t]},e.getExpResult=function(t,r){var a=t.default_value,i=r||e.searchLocalExp(t.param_name);return _.isObject(i)?_.isObject(i.config)&&(i.config.type===t.value_type?(a=i.config.value,e.trackTestTrigger(i)):_.log("\u8bd5\u9a8c\u7ed3\u679c\u7c7b\u578b\u4e0e\u671f\u671b\u7c7b\u578b\u4e0d\u4e00\u81f4\uff0cparam_name\uff1a"+t.param_name+"\uff0c\u5f53\u524d\u8fd4\u56de\u7c7b\u578b\u4e3a\uff1a"+i.config.type+"\uff0c\u671f\u671b\u7c7b\u578b\u4e3a\uff1a"+t.value_type)):_.log("\u672c\u5730\u672a\u67e5\u8be2\u5230\u8bd5\u9a8c\u6570\u636e\uff0c\u8bd5\u9a8c\u53c2\u6570\u540d\u79f0\uff1a"+t.param_name),a},e.getResultFromServer=function(t){var r=(t=_.isObject(t)?t:{}).para||{},a=t.suc,i=t.fail,s=e.creatRequestData(r);e.request({url:e.para.url,method:"POST",data:JSON.stringify(s),contentType:"application/json",timeout:r.timeout_milliseconds||e.para.timeout_milliseconds,suc:a,fail:i}),_.log("\u5411\u670d\u52a1\u7aef\u53d1\u8d77\u8bd5\u9a8c\u8bf7\u6c42")}}var para={url:"",project_key:"",retry_times:3,timeout_milliseconds:3e3,update_interval:6e5},info={lib_version:"1.21.7",plugin_version:"1.21.7",platform:"QuickApp",storage_key:"sensorsdata2015_ABTest",lib_plugin_name:"quickapp_abtesting"},props={$manufacturer:"",$model:"",$brand:"",$os:"",$os_version:""},state={inited:!1,fetchInterval:null,test_list:{},trigger_list:[],store_inited:!1,fetch_queue:[]};function mixinConfig(e){e.para=para,e.info=info,e.state=state,e.props=props,e.plugin_name="ABTestingQuickApp"}var getDistinctId=function(e){var t="";return e._sa&&e._sa.store&&(t=e._sa.store.getDistinctId()),t};function mixinTrack(e){e.trackTestTrigger=function(t){var r=!1,a=!0;if(t.is_white_list)return!1;var i=t.abtest_experiment_group_id,s=getDistinctId(e),n=t.abtest_experiment_id,o=e.store.getStorage("sensorsdata_abtest_trigger")||{};function c(){a=!1,o[s][n]=i,e.store.setStorage("sensorsdata_abtest_trigger",o)}if(o[s]&&(r=!0),o&&o[s]){var u=o[s];u[n]?u[n]!==i&&(delete u[n],c()):c()}else o[s]={},c();if(!a){var l={$abtest_experiment_id:n,$abtest_experiment_group_id:i};if(!r){var _=e.info.lib_plugin_name+":"+e.info.lib_version;l.$lib_plugin_version=[_]}e._sa.track("$ABTestTrigger",l)}}}var request=function(e){var t=e.url,r="GET",a=null;e.method&&(r=e.method),e.data&&(a=e.data),fetch.fetch({data:a,responseType:"Object",method:r,url:t,success:function(t){var r={};if(t.data)try{r=JSON.parse(t.data)}catch(e){r={}}e.suc(r)},fail:e.fail})};function mixinRequest(e){e.request=request}var ABTest={};mixinConfig(ABTest),mixinFetch(ABTest),mixinTrack(ABTest),mixinRequest(ABTest),mixinStore(ABTest),ABTest.init=function(e,t){return _.isObject(t.app)?t.app.sensorsABTest=ABTest:_.log("\u8bf7\u4f20\u5165\u6b63\u786e\u7684 App \u5bf9\u8c61\uff01"),_.log("\u521d\u59cb\u5316 ABTest \u63d2\u4ef6"),!this.state.inited&&(initAPI(ABTest),!!this.setPara(t)&&(this.state.inited=!0,this._sa=e,this.subId=new e.eventSub(this.handleEvents),this.subId.isReady(),void getStorage(ABTest.info.storage_key,ABTest.getTestList)))},ABTest.handleEvents=function(e){if("changeDistinctId"===e&&(ABTest.state.test_list={},ABTest.state.trigger_list=[],setStorage(ABTest.info.storage_key,ABTest.state.test_list),ABTest.fetchTest()),"initStore"===e){if(ABTest.state.store_inited)return!1;ABTest.state.store_inited=!0,_.getSystemInfo(ABTest,ABTest.fetchTest),ABTest.state.fetch_queue.length>0&&_.each(ABTest.state.fetch_queue,function(e){ABTest[e.event].apply(ABTest,e.arg)})}},ABTest.getTestList=function(e){_.isObject(e)?ABTest.state.test_list=e:ABTest.state.test_list={}},_.each(["fetchTest","asyncFetch"],function(e){var t=ABTest[e];ABTest[e]=function(){ABTest.state.store_inited?t.apply(ABTest,arguments):ABTest.state.fetch_queue.push({event:e,arg:arguments})}}),defineApi(ABTest,["asyncFetchABTest","fastFetchABTest","fetchCacheABTest"]);export default ABTest;