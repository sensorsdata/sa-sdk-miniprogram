"use strict";var hasOwnProperty=Object.prototype.hasOwnProperty;function isFunction(e){if(!e)return!1;var t=Object.prototype.toString.call(e);return"[object Function]"==t||"[object AsyncFunction]"==t}function isObject(e){return null!=e&&"[object Object]"==Object.prototype.toString.call(e)}function isString$1(e){return"[object String]"==toString.call(e)}function log(){if("object"==typeof console&&console.log){isString$1(arguments[0])&&(arguments[0]="sensors registerProperties————"+arguments[0]);try{return console.log.apply(console,arguments)}catch(e){console.log("sensors registerProperties————",arguments[0])}}}function extend(e){return each(Array.prototype.slice.call(arguments,1),function(t){for(var s in t)void 0!==t[s]&&(e[s]=t[s])}),e}function each(e,t,s){var r=Array.prototype.forEach,n={};if(null==e)return!1;if(r&&e.forEach===r)e.forEach(t,s);else if(e.length===+e.length){for(var o=0,i=e.length;o<i;o++)if(o in e&&t.call(s,e[o],o,e)===n)return!1}else for(var c in e)if(hasOwnProperty.call(e,c)&&t.call(s,e[c],c,e)===n)return!1}var _={isFunction:isFunction,isObject:isObject,extend:extend,log:log,each:each},RegisterProperties={status:!1,version:"props_sdk_version"},register_list=[];function onEventSend(e){var t=RegisterProperties._sa;return _.isObject(e)&&"track"===e.type?(t._.info&&t.store&&_.isFunction(t.store.getProps)&&(e.properties=_.extend({},t._.info.properties,t.store.getProps(),t._.info.currentProps,e.properties)),getRegisterProperties(e)):{}}function getRegisterProperties(e){var t={};return _.each(register_list,function(s){var r={};if(_.isFunction(s))r=s({event:e.event,properties:e.properties,data:e});else-1!==s.events.indexOf(e.event)&&(r=s.properties);t=Object.assign(t,r)}),_.isObject(t)?t:{}}RegisterProperties.init=function(e){if(!e||!_.isObject(e))return _.log("\u8bf7\u4f20\u5165\u6b63\u786e\u7684 sensors \u5bf9\u8c61\uff01"),!1;if(RegisterProperties._sa=e,e.kit&&_.isObject(e.kit)){var t=e.kit.onEventSend;e.kit.onEventSend=function(s){var r=t(s),n=onEventSend(s);return e._.extend(r,n)}}RegisterProperties.status=!0},RegisterProperties.register=function(e){e&&_.isObject(e)?e.properties&&_.isObject(e.properties)&&e.events&&e.events.length>0&&register_list.push(e):_.log("\u53c2\u6570\u9519\u8bef\uff01")},RegisterProperties.hookRegister=function(e){_.isFunction(e)&&register_list.push(e)};var flag="data:enc;",store={_sa:null,readObjectVal:function(e){try{var t=store._sa._.getStorageSync(e)||"";return store._sa._.isString(t)&&-1!==t.indexOf(flag)&&(t=t.substring(flag.length),t=JSON.parse(store._sa._.rot13defs(t))),t}catch(e){return null}},saveObjectVal:function(e,t){var s="";store._sa._.isObject(t)?s=flag+store._sa._.rot13obfs(JSON.stringify(t)):store._sa._.isString(t)&&-1===t.indexOf(flag)&&(s=flag+store._sa._.rot13obfs(t)),store._sa._.setStorageSync(e,s)}},_sa=null,_$1={isObject:function(e){return null!=e&&"[object Object]"==toString.call(e)},log:function(){if("object"==typeof console&&console.log){isString(arguments[0])&&(arguments[0]="sensors sessionEvent---"+arguments[0]);try{return console.log.apply(console,arguments)}catch(e){console.log("sensors sessionEvent---",arguments[0])}}}},STORAGE_NAME="sensorsdata2015_wechat_session",SessionEvent={version:"props_sdk_version",storage_name:STORAGE_NAME,init:function(e){if(!e||"object"!=typeof e)return _$1.log("\u8bf7\u4f20\u5165\u6b63\u786e\u7684 sensors \u5bf9\u8c61\uff01"),!1;_sa=e,store._sa=e,_$1.log=e._.logger,RegisterProperties.init(e),RegisterProperties.hookRegister(SessionEvent.addSessionID)},addSessionID:function(){var e=+new Date,t=store.readObjectVal(SessionEvent.storage_name)||{},s=t.first_session_time,r=t.latest_session_time;!s||!r||s>e||r>e||e-s>432e5||e-r>18e5?t={session_id:_sa.store.getUUID().replace(/-/g,""),first_session_time:e,latest_session_time:e}:t.latest_session_time=e;return store.saveObjectVal(SessionEvent.storage_name,t),{$event_session_id:t.session_id}}};module.exports=SessionEvent;